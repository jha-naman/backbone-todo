<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <title>Todo</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js" type="text/javascript"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js" type="text/javascript"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.0/backbone.localStorage-min.js" type="text/javascript"></script>
        <link href="http://mincss.com/entireframework.min.css" rel="stylesheet" type="text/css">
        <style>
	body {
	width: 80%;
	margin-right: auto;
	margin-left: auto;
	text-align: center;
	}
	</style>
    </head>
    <body>
    <div id='container'>
        <div id="input">
            Title: <input type="text" id='title' placeholder='Enter item to do here' autofocus>
            Category: <input type="text" id='category' placeholder='Enter Category of todo'>
            <input type="button" id='add' value='Submit' >
        </div>
        <h4> ToDo List </h4>
            <div id="todo-list">
 
            </div>
        </table>
    </div>
        <script type="text/template" charset="utf-8" id='todo'>
            <span class='todo-title'> <%- title %>  </span>
            <span class='todo-category'> <%- category %>  </span>
            <span class='todo-completed'> <%- completed %> </span>
            <input type=button name="toggle" value='Toggle Status' id=' <%- id %> ' onCLick=appView.toggle(this)> 
        </script>
        <script type="text/template" charset="utf-8" id='category-template'>
            <h3> Category: <%- category %> </h3>
            <div id=" <%- category_id %>">
                
            </div>
        </script>
        <script type="text/javascript" charset="utf-8">
var app = {}

app.todo = Backbone.Model.extend({
            defaults: {
                title: '',
                category: 'misc',
                completed: false,
                id: undefined
            }
        });
app.todolist = Backbone.Collection.extend({
            model: app.todo,
            localStorage: new Store('ToDo-store')
        });
app.List = new app.todolist();

app.categoryView = Backbone.View.extend({
            template: _.template($('#category-template').html()),
            initialize: function(params) {
                this.category = params.params;
            },
            render: function() {
            this.$el.html(this.template(this.category));  // {category_id: id, category: "category"}
            return this;
            }
        });

app.todoView = Backbone.View.extend({
            template: _.template($('#todo').html()),
            render: function() {
                this.$el.html(this.template(this.model.toJSON()));
                return this;
            }
        });
app.View = Backbone.View.extend({
        el: '#container',
        initialize: function() {
            app.List.on('add reset', this.addAll, this);
            app.List.fetch();
        },
        events: {
        'click #add': 'addToList',
        },
        id: 0,
        addToList: function() {

            var title = $('#title').val();
            var category = $('#category').val();
            app.List.add({'title': title, 'category': category, completed: false, id: ++(this.id)});
        },
        addAll: function() {
            $('#todo-list').html('');
            var categories_dup = app.List.pluck('category');
            var categories = [];
            categories_dup.forEach(function(category) {
                        if (categories.indexOf(category) < 0){
                        categories.push({'category': category, 'category_id': '#' + category});
                            return;
                        }
                    });
            categories.forEach(this.addCategory, this);
            //app.List.forEach(this.addOne, this);
        },
        addCategory: function(category) {
            var catView = new app.categoryView({ params: category });
            $("#todo-list").append(catView.render().el);
            var todoModels = app.List.where({'category': category.category});
            todoModels.forEach(function(todo) {
                        $('#' + category.category).html('');
                        var view = new app.todoView({model: todo});
                        var id = '#'+todo.get('category');
                        $('#' + category.category).append(view.render().el);
                    }, this);
        },
        addOne: function(todo) {
            var view = new app.todoView({model: todo});
            $('#todo-list').append(view.render().el);
        },
        toggle: function(element) {
           var model = app.List.get(parseInt(element.id));
           model.set('completed', !model.get('completed'));
           appView.addAll();
        }
});
var appView = new app.View();
        </script>
    </body>
</html>
